/*
 * XFreq.c by CyrIng
 *
 * A Widget to display the frequency & the temperature of each core in the Intel i7 processor.
 *
 * Copyright (C) 2013-2014 CYRIL INGENIERIE
 * http://blog.cyring.fr
 *
 * Licenses: GPL2
 *
 *
 * [TODO]
 *
 *  Hardware
 * ----------
 *
 * + power energy performance counters
 *
 * + kernel module : to reduce cpu usage near to 0.01%
 *     using mmap to transfer the complete RO data structure to userland.
 *     compute the best idle sleep time.
 *     change from "pull" to "push" with a "data is ready" event.
 *
 * + memory fetch : to remove dependancies with the dmi_sysfs & msr Linux modules.
 *     using a R/O mmap to "/dev/mem".
 *     base clock is a 2 bytes word found at address 0xf08d9 + 0x12 (Rampage II GENE) : done.
 *     rather use the msr assembler instruction.
 *
 * + GPU sensors.
 *     compile with the NVIDIA (first), the AMD & Intel frameworks (seconds) ?
 *
 * + other processors are claimed. Call to beta testers.
 * + implement the procstat API to trace high cpu load processes.
 * + scripting, editor, push alarms : write user defined bit values in MSR.
 *
 *
 *  Graphical
 * -----------
 *
 * + power energy Widget using a slider to:
 *     select a Policy Preference in IA32_ENERGY_PERF_BIAS , MSR_MISC_PWR_MGMT(0x1aa),
 *     set On-Demand Clock Modulation in IA32_CLOCK_MODULATION(0x19a) (duplicated for each Thread),
 *     enable / disable C1E in MSR_POWER_CTL(0x1fc),
 *     C-State auto demotion with MSR_PKG_CST_CONFIG_CONTROL(0xe2).
 * + some button-switchs & sliders to enable/disable/set the PKG/Core features in the System Info Widget.
 * + full transparency & opacity.
 * + integrate XCB, wayland ?
 * + handle skins :
 * + provide a processor usage history.
 * + gradiant coloring.
 * + screenshot key.
 * + resize footer separator w/ MDI.
 * + give a better disposal of the Widgets using % of screen size and absolute positions.
 * + save and load settings : done.
 * + show the minimum value in the Temp Widget : on the graphic, left side=min & right side=max : done.
 *
 *
 *  Source code
 * -------------
 * + clean makefile : remove my previous Raspberry instructions : done.
 * + clang compliant : rewrite code to remove any "warning: use of GNU old-style ..."
 * + provide some configure and install scripts, especially an ArchLinux PKGBUILD.
 * + split the code between GUI and hardware parts.
 * + release candidate.
 *
 *
 *   Issues
 * ----------
 * + The live CD is too big (up to 500 MB).
 *     So I packed other benchmark tools inside ;-)
 *
 * + The temperature thresholds MSR does not return any value.
 *     Need to investigate ACPI.
 *
 * + Using the TWM manager, the first disposal of the Widgets is not applied : solved.
 *
 * + Program freeze after a long run. Probably due to a semaphore lock overload.
 *
 * + XFreq tested ok with a 3770K, however BIOS DMI is not reliable : solved.
 *     Thus, the number of active Cores or Threads will be count from CPUID and the appropriate MSR.
 *     Solved with Processor topology enumeration.
 *
 * + Fast-Strings reported as not available in CPUID but enabled in MSR.
 *
 *
 * [HISTORY]
 *
 * R 0.22 : 03/24 2014 SR-3
 *        - Save settings into the '.xfreq' file in home directory.
 *
 * R 0.22 : 03/23 2014 SR-2
 *        - Load settings from .xfreq file in home directory.
 *        - Provided a new button to Reset the coldest temperature.
 *        - Added the '-i' command line argument to hide the Splash screen.
 *        - Fixed margins when in non MDI.
 *        - Fixed the scale of the Cold Temperature.
 *
 * R 0.22 : 03/20 2014 SR-1
 *        - Fixed the Splash startup.
 *
 * R 0.22 : 03/19 2014
 *        - The initial disposal of the Widgets is corrected.
 *        - Change the scale of the temperature graphic.
 *        - Added a splash screen during the initialization.
 *        - Postponed the Thermal thresholds treatment.
 *        - Display the followings into the System Info Widget:
 *            Hardware Lock Elision (HLE)
 *            Restricted Transactional Memory (RTE)
 *            All Turbo Boost Ratios
 *            BM1 / BM2
 *            Topology & State of CPU
 *            Performance Counters matrix
 *        - Removed the '-c' (per Core) argument.
 *            AnyThread Counters are now automatically set just after the Processor topology enumeration function.
 *
 * R 0.21 : 03/15 2014 SR-2
 *        - Allows to read the Base Clock frequency at a user's specified address in ROM memory.
 *            use the new command line argument '-M'
 *            defaults to 0xf08d9 + 0x12 which is the ASUS Rampage II GENE motherboard address.
 *
 * R 0.21 : 03/14 2014 SR-1
 *        - Fix the Topology algorithm to get a list of enabled CPU and show if HTT is enabled.
 *        - Fix a Graphic regression in the Widget Temperature. Now displays the coldest value.
 *
 * R 0.21 : 03/12 2014
 *        - Implemented an enumeration of the Processor topology to get a list of the activated Threads and Cores;
 *            and conclude if Hyperthreading is actually enabled.
 *
 * R 0.20 : 03/07 2014
 *        - Provide an option to select the Clock source between the TSC, BIOS, Specifications, ROM, and an user defined value.
 *            Use the '-S' command line argument or one of the buttons in the System Info Widget.
 *            The current source is displayed beside the Base Clock.
 *
 * R 0.19 : 03/06 2014 SR-2
 *        - Added a new Quit decoration button.
 *        - Modified the Minimize decoration button.
 *        - Fix the scrolling boundaries & the icon names updates.
 *
 * R 0.19 : 03/05 2014 SR-1
 *        - Fix the icons size & position.
 *        - To get a smoother motion, the Scrolling code has been reprogrammed using an additional pixmap.
 *
 * R 0.19 : 03/01 2014
 *        - Allow the Widget title to be still refreshed when the window is minimized, iconified or paused.
 *            By the way, when MDI is enabled, the title of the main window is updated with the top frequency & temperature.
 *        - Solved the Widgets moving issue using the 'ConfigureNotify' event.
 *            However the top frame border added by the WM is not counted in the Window position.
 *
 * R 0.18 : 02/27 2014 SR-3
 *        - Kernel NMI Watchdog must be disabled because it interferes XFreq when reading UNC & URC counters.
 *            to disable the watchdog, append the Kernel parameter nmi_watchdog=0
 *            or into Shell, echo "0" > /proc/sys/kernel/nmi_watchdog before starting XFreq.
 *
 *        - The semaphore locks the drawing thread when increasing, decreasing the loop idle time.
 *        - The loop idle time is displayed in the System Info Widget.
 *        - The Processor Brand name is now shown beside the System Info title :
 *            a new button [Brand] starts and stops this wallboard.
 *        - An new argument "-a" is provided to enable or disable X Access Control List".
 *
 * R 0.18 : 02/26 2014 SR-2
 *        - The decoration is now put on the top-right corner.
 *        - A message is output when Counters are reset.
 *
 * R 0.18 : 02/24 2014 SR-1
 *        - In case of counters overflowed, reset them.
 *        - In the System Info Widget, two buttons are added to increase, decrease the sleep time.
 *        - A "ReClock" button in the System Info Widget allows to re-estimate the Base Clock.
 *        - The Mouse Cursors are implemented.
 *        - Moving the Widgets is managed in both cases, with or without the MDI mode.
 *          Thus, no Window Manager is required. Use right mouse button to move a Widget.
 *
 * R 0.17 : 02/22 2014 SR-5
 *        - Clean up some code.
 *        - Added to System Info Widget the CPUID functions :
 *            leaf (0x6) Digital Thermal Sensor & Power Management
 *            leaf (0x7) Extended Feature Flags
 *            leaf (0xa) Performance Monitoring
 *
 * R 0.17 : 02/20 2014 SR-4
 *        - Display Ratio formula :
 *
 *            DisplayRatio=TurboRatio x State(C0) * MaxNonTurboRatio
 *              where
 *                  TurboRatio=Delta(UCC) / Delta(URC)
 *              and State(C0)=Delta(URC) / Delta(TSC)
 *              and MaxNonTurboRatio=MSR_PLATFORM_INFO[15-8]
 *
 * R 0.17 : 02/18 2014 SR-3
 *        - In Cycles calculation, test for 64 bits overflow.
 *
 * R 0.17 : 02/16 2014 SR-2
 *        - Added Decoration buttons.
 *        - Highlight button when clicked.
 *
 * R 0.17 : 02/15 2014 SR-1
 *        - Corrected the Turbo ratio calculation.
 *        - A Core frequency is displayed when the ratio is greater or equal 5
 *        - A minimized Widget has an associated icon button in the Main Widget right bar.
 *        - Cycle and C-State options are now dissociated.
 *
 * R 0.16 : 02/12 2014 SR-5
 *        - Registers Dump Widget is now auto refreshed.
 *        - [CTRL]+[P] or startup option '-p 1'prints the following :
 *            Raw Cycles values in the Core Widget.
 *            C-States % in its own Widget.
 *        - In the System Info Widget the Base Clock frequency is now printed below the Processor brand string.
 *
 * R 0.16 : 02/11 2014 SR-4
 *        - In main() provide a none stop program startup and log any missing prerequisites.
 *        - Modified Ratio & Frequency computation to Relative values.
 *
 * R 0.16 : 02/10 2014 SR-3
 *        - A few scripting commands are implemented.
 *        - The mouse is supported for some functions such as scrolling buttons and moving Widget.
 *        - Rolling back to an unique input buffer located in the MAIN Widget:
 *            some option keys need to be pressed with the [Control] key.
 *        - Simplify all code using macros:
 *            [Quarter][Half][One][Twice][Twice_Half]_Char_Width
 *            [Quarter][Half][One][Twice][Twice_Half]_Char_Height
 *
 * R 0.16 : 02/01 2014 SR-2
 *        - Implemented a global handling of input characters string.
 *
 * R 0.16 : 01/31 2014 SR-1
 *        - Added a new Widget to dump MSR registers in binary.
 *
 * R 0.16 : 01/29 2014
 *        - Read the TSC per logical Core using IA32_TIME_STAMP_COUNTER(0x10) rather than RDTSC instruction.
 *        - Integrate the Misc Processor Features into the System Info Widget. See IA32_MISC_ENABLE(0x1a0).
 *        - Attempt to handle the temperature Threshold values with IA32_THERM_INTERRUPT(0x19b) : no data !
 *
 * R 0.15 : 01/28 2014 SR-4
 *        - Reorganized the time critical part in the uCycle thread.
 *        - Reduced the CPU overhead in Events loop and the Drawing thread.
 *
 * R 0.15 : 01/24 2014 SR-3
 *        - Cosmetic changes with the MDI window. Use '-D 1' to enable the MDI.
 *        - Minimizing or unmapping a widget stops its drawing.
 *        - The command argument '-D' enables the Multiple Document Interface management mode.
 *        - The Widgets are now gracefully disposed.
 *        - Added an architecture table with default processors values.
 *        - Implemented the C3 and C6 C-States counters.
 *        - Create 2 new Widgets:
 *            C-States per Core and in Processor average.
 *            Temperature per Core and hottest.
 *        - Protect the drawing thread with a mutex.
 *        - Scroll the Processor brand name (Wallboard).
 *        - Changed the action associated with [Page Down] & [Page Up] keys.
 *        - The [+] and [-] keys of the NumPad allow to decrase or increase the idle time.
 *        - In the Core Widget :
 *            the [H] key hide / unhide the frequencies.
 *            the [P] key hide / unhide the C-States counters.
 *        - The System Information Widget now gathers all detail about Processor, RAM and BIOS.
 *
 * R 0.14 : 01/19 2014
 *        - Added the option '-c' to monitor the processor either per threads, either per cores.
 *        - The Cores load is now based on the C0 performance counter and relatively to the TSC.
 *
 * R 0.13 : 01/14 2014 SR-1
 *        - The program is changed from 2 to 3 threads:
 *            uCycle to compute the actual frequency.
 *            uDraw to paint the foreground.
 *            uLoop to handle X events. (called by the main thread)
 *        - The calculation of the Cores frequency is now as follow :
 *            (Base Operating Ratio) x (Delta of Unhalted Cycles) x (Bus CLOCK frequency)
 *
 * R 0.12 : 01/14 2014
 *        - Use the MSR performance counters to provide a better computation accuracy of the Cores frequency multiplier.
 *        - Intel Core Architecture detected.
 *        - Blink yellow when in pause mode.
 *
 * R 0.11 : 01/09 2014
 *        - add specifications pages for Processor (features), RAM (timings & channels count) and BIOS (BCLK).
 *            press [F1] to get help and scroll with arrow keys.
 *        - provide a compact string for processor brand.
 *        - better font support.
 *            layout scaling is based on loaded font.
 *            "fixed" font as a default.
 *
 * R 0.10 : 01/04 2014
 *        - the MSR readings are optimized a little bit, however turbo ratios don't show up yet.
 *        - drawing is now done with 2 pixmaps :
 *            B, for the background layout,
 *            F, to display the dynamics.
 *        - the event loop does not sleep anymore but waits for any event on the socket.
 *        - the '-a' argument allows to show the activity of the loop.
 *        - transparency only works with a composite manager.
 *        - the project is ported to Code::Blocks, however not delivered yet.
 *        - semaphore lock is still questioned ?
 * R 0.09 : 01/01 2014
 *        - PAUSE key to suspend drawing.
 *        - double buffering.
 *        - pseudo transparency with any window id (see option -D[esktop]).
 *        - read SMBIOS @ 0x24 to get the true number of active Core threads (instead of CPUID).
 *        - some drawing alignment; text scaling; coloring based on the ratios.
 *        - add the temperature & a few spaces in the application title name.
 *        - inform the WM of the Widget fixed size : no resize faisable.
 *        - new option -s to set the idle time (micro-seconds) inside function uExec().
 *        - leave Event Loop, uLoop() as the main thread.
 * R 0.08 : Widget ready as a beta release.
 * R 0.01 to 0.07 : initial source code.
 */
